<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ShopEase — Admin (Client-side)</title>
    <meta name="description" content="Admin mockup — add / edit / delete products (client-side only).">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">

    <style>
        /* small admin-specific tweaks */
        .admin-toolbar {
            gap: .5rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .product-table img {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .75rem;
        }

        @media (max-width: 767.98px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- NAV / simple -->
    <header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">ShopEase Admin</a>
            <div class="ms-auto admin-toolbar">
                <button class="btn btn-outline-secondary" onclick="location.href='index.html'"><i
                        class="bi bi-house"></i> View Store</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal"
                    id="addProductBtn">
                    <i class="bi bi-plus-lg"></i> Add Product
                </button>
                <button class="btn btn-sm btn-light" id="syncBtn" title="Save current products to localStorage">Save
                    Snapshot</button>
            </div>
        </div>
    </header>

    <main class="container my-5">
        <h3 class="mb-3">Product Manager (Client-side)</h3>

        <!-- Search / Filter -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="input-group" style="max-width:520px;">
                <input id="adminSearch" class="form-control" placeholder="Find product by title, brand or id..."
                    aria-label="Search products">
                <button class="btn btn-outline-secondary" id="adminSearchBtn"><i class="bi bi-search"></i></button>
            </div>
            <div class="d-flex gap-2">
                <select id="adminSort" class="form-select form-select-sm">
                    <option value="newest">Newest</option>
                    <option value="price_asc">Price ↑</option>
                    <option value="price_desc">Price ↓</option>
                </select>
                <button class="btn btn-outline-danger btn-sm" id="clearLocalBtn" title="Clear saved snapshot">Clear
                    Snapshot</button>
            </div>
        </div>

        <!-- Products table -->
        <div class="card rounded-4 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0 product-table">
                        <thead class="small text-muted bg-light">
                            <tr>
                                <th style="width:80px">Image</th>
                                <th>Title & Brand</th>
                                <th style="width:120px">Price</th>
                                <th style="width:110px">Rating</th>
                                <th style="width:120px">Inventory</th>
                                <th style="width:180px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminProductsTbody">
                            <!-- JS injects rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Empty hint -->
        <div id="adminEmpty" class="text-center text-muted mt-4 d-none">
            <p>No products found. Add your first product.</p>
        </div>
    </main>

    <!-- Product Modal (Add / Edit) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="productForm" class="modal-body">
                    <div class="form-grid">
                        <input type="hidden" id="prodId">
                        <div>
                            <label class="form-label">Title</label>
                            <input id="prodTitle" class="form-control" required>
                        </div>
                        <div>
                            <label class="form-label">Brand</label>
                            <input id="prodBrand" class="form-control">
                        </div>
                        <div>
                            <label class="form-label">Category</label>
                            <input id="prodCategory" class="form-control" placeholder="e.g. Electronics / Men / Home">
                        </div>
                        <div>
                            <label class="form-label">Price (₹)</label>
                            <input id="prodPrice" class="form-control" type="number" min="0" required>
                        </div>
                        <div>
                            <label class="form-label">MRP (₹)</label>
                            <input id="prodMrp" class="form-control" type="number">
                        </div>
                        <div>
                            <label class="form-label">Discount (%)</label>
                            <input id="prodDiscount" class="form-control" type="number" min="0" max="99">
                        </div>
                        <div>
                            <label class="form-label">Rating (0-5)</label>
                            <input id="prodRating" class="form-control" type="number" min="0" max="5" step="0.1">
                        </div>
                        <div>
                            <label class="form-label">Inventory</label>
                            <input id="prodInventory" class="form-control" type="number" min="0">
                        </div>
                        <div>
                            <label class="form-label">Image URL (Unsplash recommended)</label>
                            <input id="prodImage" class="form-control" placeholder="https://images.unsplash.com/..."
                                required>
                        </div>
                        <div>
                            <label class="form-label">Additional Images (comma separated URLs)</label>
                            <input id="prodImages" class="form-control" placeholder="url1, url2">
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label class="form-label">Short Description</label>
                            <input id="prodShort" class="form-control">
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label class="form-label">Long Description</label>
                            <textarea id="prodDesc" rows="4" class="form-control"></textarea>
                        </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveProductBtn">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm delete modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-body text-center p-4">
                    <p class="mb-3">Are you sure you want to delete this product?</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Shared data + script -->
    <script src="js/data.js"></script>
    <script src="js/script.js"></script>

    <!-- Admin script -->
    <script>
        (function () {
            'use strict';

            // Admin uses a snapshot mechanism: reads from window.products (from js/data.js)
            // and allows saving a local 'shop_data' snapshot in localStorage for demo persistence.
            const LS_SNAPSHOT = 'shop_data';
            // We'll operate on window.products copy
            let products = Array.isArray(window.products) ? structuredClone(window.products) : [];
            // If a snapshot exists in localStorage, prefer it
            const saved = localStorage.getItem(LS_SNAPSHOT);
            if (saved) {
                try {
                    products = JSON.parse(saved);
                } catch (e) { /* ignore corrupt snapshot */ }
            }

            // DOM refs
            const tbody = document.getElementById('adminProductsTbody');
            const emptyHint = document.getElementById('adminEmpty');
            const searchInput = document.getElementById('adminSearch');
            const searchBtn = document.getElementById('adminSearchBtn');
            const sortSelect = document.getElementById('adminSort');
            const clearLocalBtn = document.getElementById('clearLocalBtn');
            const syncBtn = document.getElementById('syncBtn');

            // Modal refs
            const productModal = new bootstrap.Modal(document.getElementById('productModal'));
            const productForm = document.getElementById('productForm');
            const modalTitle = document.getElementById('productModalTitle');
            const saveBtn = document.getElementById('saveProductBtn');

            const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let deleteTargetId = null;

            // form fields
            const fId = document.getElementById('prodId');
            const fTitle = document.getElementById('prodTitle');
            const fBrand = document.getElementById('prodBrand');
            const fCategory = document.getElementById('prodCategory');
            const fPrice = document.getElementById('prodPrice');
            const fMrp = document.getElementById('prodMrp');
            const fDiscount = document.getElementById('prodDiscount');
            const fRating = document.getElementById('prodRating');
            const fInventory = document.getElementById('prodInventory');
            const fImage = document.getElementById('prodImage');
            const fImages = document.getElementById('prodImages');
            const fShort = document.getElementById('prodShort');
            const fDesc = document.getElementById('prodDesc');

            // utilities
            function uid(prefix = 'p') {
                return prefix + '_' + Math.random().toString(36).slice(2, 9);
            }

            function renderTable(list) {
                tbody.innerHTML = '';
                if (!list.length) {
                    emptyHint.classList.remove('d-none');
                    return;
                }
                emptyHint.classList.add('d-none');
                list.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td><img src="${p.images?.[0] || 'https://via.placeholder.com/80'}" alt="${p.title}"></td>
            <td>
              <div class="fw-semibold">${p.title}</div>
              <div class="small text-muted">${p.brand || ''} • ${p.category || ''}</div>
            </td>
            <td>₹${p.price?.toLocaleString('en-IN') || 0}</td>
            <td><span class="small">${p.rating || 0}</span></td>
            <td><span class="badge ${p.inventory > 0 ? 'bg-success' : 'bg-secondary'}">${p.inventory}</span></td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-light editBtn" data-id="${p.id}"><i class="bi bi-pencil"></i> Edit</button>
                <button class="btn btn-sm btn-outline-danger delBtn" data-id="${p.id}"><i class="bi bi-trash"></i> Delete</button>
                <button class="btn btn-sm btn-outline-primary viewBtn" data-id="${p.id}"><i class="bi bi-eye"></i> View</button>
              </div>
            </td>
          `;
                    tbody.appendChild(tr);
                });
                // wire actions
                tbody.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', onEdit));
                tbody.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', onDelete));
                tbody.querySelectorAll('.viewBtn').forEach(b => b.addEventListener('click', onView));
            }

            function onEdit(e) {
                const id = e.currentTarget.dataset.id;
                const p = products.find(x => x.id === id);
                if (!p) return;
                modalTitle.textContent = 'Edit Product';
                fId.value = p.id;
                fTitle.value = p.title;
                fBrand.value = p.brand;
                fCategory.value = p.category;
                fPrice.value = p.price;
                fMrp.value = p.mrp || '';
                fDiscount.value = p.discount || '';
                fRating.value = p.rating || '';
                fInventory.value = p.inventory || 0;
                fImage.value = p.images?.[0] || '';
                fImages.value = (p.images || []).slice(1).join(', ');
                fShort.value = p.shortDescription || '';
                fDesc.value = p.description || '';
                productModal.show();
            }

            function onDelete(e) {
                deleteTargetId = e.currentTarget.dataset.id;
                confirmDeleteModal.show();
            }

            confirmDeleteBtn.addEventListener('click', function () {
                if (!deleteTargetId) return;
                products = products.filter(p => p.id !== deleteTargetId);
                persistSnapshot();
                renderTable(products);
                confirmDeleteModal.hide();
                shopToast('Product deleted');
            });

            function onView(e) {
                const id = e.currentTarget.dataset.id;
                // open product page in new tab using product id param
                window.open('product.html?id=' + encodeURIComponent(id), '_blank');
            }

            // Save form (add or update)
            productForm.addEventListener('submit', function (ev) {
                ev.preventDefault();
                // basic validation
                if (!fTitle.value.trim() || !fPrice.value || !fImage.value.trim()) {
                    alert('Please provide Title, Price and Image URL.');
                    return;
                }
                const pdata = {
                    id: fId.value || uid('p'),
                    title: fTitle.value.trim(),
                    brand: fBrand.value.trim(),
                    category: fCategory.value.trim(),
                    price: Number(fPrice.value) || 0,
                    mrp: fMrp.value ? Number(fMrp.value) : undefined,
                    discount: fDiscount.value ? Number(fDiscount.value) : undefined,
                    rating: fRating.value ? Number(fRating.value) : 0,
                    inventory: fInventory.value ? Number(fInventory.value) : 0,
                    images: [fImage.value.trim()].concat((fImages.value || '').split(',').map(s => s.trim()).filter(Boolean)),
                    shortDescription: fShort.value.trim(),
                    description: fDesc.value.trim(),
                    popularity: Math.floor(Math.random() * 100),
                    createdAt: new Date().toISOString()
                };

                // if id exists, update
                const idx = products.findIndex(x => x.id === pdata.id);
                if (idx > -1) {
                    products[idx] = pdata;
                    shopToast('Product updated');
                } else {
                    products.unshift(pdata); // add to top
                    shopToast('Product added');
                }
                productForm.reset();
                fId.value = '';
                productModal.hide();
                persistSnapshot();
                renderTable(products);
            });

            // search / sort
            function onSearch() {
                const q = searchInput.value.trim().toLowerCase();
                let filtered = products.slice();
                if (q) {
                    filtered = filtered.filter(p =>
                        (p.title || '').toLowerCase().includes(q) ||
                        (p.brand || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                    );
                }
                const sort = sortSelect.value;
                if (sort === 'price_asc') filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
                if (sort === 'price_desc') filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
                if (sort === 'newest') filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderTable(filtered);
            }
            searchBtn.addEventListener('click', onSearch);
            searchInput.addEventListener('keyup', function (e) {
                if (e.key === 'Enter') onSearch();
            });
            sortSelect.addEventListener('change', onSearch);

            // persist snapshot (save to localStorage)
            function persistSnapshot() {
                try {
                    localStorage.setItem(LS_SNAPSHOT, JSON.stringify(products));
                } catch (e) {
                    console.error('Failed to save snapshot', e);
                }
            }

            // clear local snapshot (reset to original window.products)
            clearLocalBtn.addEventListener('click', function () {
                if (!confirm('Clear saved snapshot? This will restore initial demo data.')) return;
                localStorage.removeItem(LS_SNAPSHOT);
                products = Array.isArray(window.products) ? structuredClone(window.products) : [];
                renderTable(products);
                shopToast('Snapshot cleared');
            });

            // sync button: also expose snapshot under window for debugging
            syncBtn.addEventListener('click', function () {
                persistSnapshot();
                window.products = structuredClone(products);
                shopToast('Snapshot saved to localStorage');
            });

            // utility toast consistent with ShopApp.toast if available
            function shopToast(msg) {
                if (window.ShopApp && typeof window.ShopApp.toast === 'function') return window.ShopApp.toast(msg);
                const t = document.createElement('div');
                t.className = 'position-fixed bottom-0 end-0 m-3 bg-dark text-white px-3 py-2 rounded shadow';
                t.textContent = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 1600);
            }

            // initial render
            renderTable(products);

            // expose admin helpers for console
            window.AdminPanel = {
                products,
                persistSnapshot,
                restore: () => { localStorage.removeItem(LS_SNAPSHOT); products = Array.isArray(window.products) ? structuredClone(window.products) : []; renderTable(products); }
            };

        })();
    </script>
</body>

</html>